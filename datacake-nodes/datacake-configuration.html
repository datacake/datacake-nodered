<script type="text/javascript">
  RED.nodes.registerType("datacake-configuration", {
    category: "config",
    color: "#f29d00",
    defaults: {
      api_token: { value: "", required: true },
      workspace_id: { value: "", required: true },
      workspace_name: { value: "", required: false },
    },
    label: function () {
      if (this.workspace_name) {
        return `Workspace: ${this.workspace_name}`;
      } else {
        return "Invalid configuration";
      }
    },
    oneditprepare: function () {
      $("#node-config-input-api_token, #node-config-input-workspace_id").on(
        "change",
        function () {
          var api_token = $("#node-config-input-api_token").val();
          var workspace_id = $("#node-config-input-workspace_id").val();
          if (api_token.length !== 40 || workspace_id.length !== 36) {
            return;
          }
          let datacake_api_graphql = "https://api.datacake.co/graphql/";
          $.ajax({
            method: "POST",
            url: datacake_api_graphql,
            contentType: "application/json",
            headers: {
              Authorization: "Token " + api_token,
            },
            data: JSON.stringify({
              query: `query {
                    workspace(id:"${workspace_id}") {
                        id
                        name
                    }
                }`,
            }),
            success: function (result) {
              //currentDeviceId
              if (
                result &&
                result.data &&
                result.data.workspace &&
                result.data.workspace.name
              ) {
                $("#node-config-input-workspace_name").val(
                  result.data.workspace.name
                );
              }
            },
          });
        }
      );
    },
  });
</script>

<script type="text/x-red" data-template-name="datacake-configuration">
    <div class="form-row">
        <label for="node-config-input-api_token"><i class="icon-tag"></i> API Token</label>
        <input type="text" id="node-config-input-api_token" placeholder="API Token">
    </div>
    <div class="form-row">
        <label for="node-config-input-workspace_id"><i class="icon-tag"></i> Workspace ID</label>
        <input type="text" id="node-config-input-workspace_id" placeholder="Workspace ID">
    </div>
    <div class="form-row">
      <label for="node-config-input-workspace_name"><i class="icon-tag"></i> Workspace Name</label>
      <input type="text" disabled id="node-config-input-workspace_name" placeholder="Workspace Name">
  </div>
</script>

<script type="text/x-red" data-help-name="datacake-configuration">
  <p>A configuration node for Datacake's MQTT API</p>
</script>
